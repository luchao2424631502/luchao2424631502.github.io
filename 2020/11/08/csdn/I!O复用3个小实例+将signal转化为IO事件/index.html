

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/main.png">
  <link rel="icon" type="image/png" href="/img/post1.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="linux/windows/c++">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>I/O复用3个小实例+将signal转化为IO事件 - llc&#39;blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.6","typing":{"enable":true,"typeSpeed":100,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>llc'blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/post1.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="I/O复用3个小实例+将signal转化为IO事件">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-11-08 21:59" pubdate>
        2020年11月8日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      48
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">I/O复用3个小实例+将signal转化为IO事件</h1>
            
            <div class="markdown-body">
              <a id="more"></a>

<p>I/O复用3个小实例:</p>
<ol>
<li><p>nonblock connect():<strong>利用error:EINPROGRESS</strong></p>
<blockquote>
<p><strong>非阻塞connect()</strong></p>
<p>man手册connect()</p>
<p>The  socket  is nonblocking and the connection cannot be completed immediately.  (UNIX domain sockets failed with EAGAIN instead.)  It is possible to select(2) or poll(2) for completion by selecting  the socket  for  writing.   After select(2) indicates writability, use getsockopt(2) to read the SO_ERROR option at level SOL_SOCKET to determine whether connect() completed successfully (SO_ERROR  is  zero) or  unsuccessfully  (SO_ERROR  is one of the usual error codes listed here, explaining the reason for the failure).</p>
<p>非阻塞socket发起连接不能立马完成,利用io多路的写事件,然后用getsocketopt拿到socket的error,判断error是否==0,=0表示连接成功</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;me.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 1023</span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setnonblocking</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> old_option = fcntl(fd,F_GETFL);<br>    <span class="hljs-keyword">int</span> new_option = old_option | O_NONBLOCK;<br>    fcntl(fd,F_SETFL,new_option);<br>    <span class="hljs-keyword">return</span> old_option;<br>&#125;<br><br><span class="hljs-comment">//Linux下nonblock-connect()</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">unblock_connect</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ip,<span class="hljs-keyword">int</span> port,<span class="hljs-keyword">int</span> time)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;addr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(addr));<br>    addr.sin_family = AF_INET;<br>    addr.sin_port = htons(port);<br>    inet_pton(AF_INET,ip,&amp;addr.sin_addr);<br><br>    <span class="hljs-keyword">int</span> sockfd = socket(AF_INET,SOCK_STREAM,<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">int</span> fdopt = setnonblocking(sockfd);<span class="hljs-comment">//fdopt保存的是原来的fd status</span><br>    <span class="hljs-keyword">int</span> ret = connect(sockfd,(struct sockaddr*)&amp;addr,<span class="hljs-keyword">sizeof</span>(addr));<br>    <span class="hljs-comment">// 非阻塞connect直接连接成功</span><br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connect with server immediately\n&quot;</span>);<br>        fcntl(sockfd,F_SETFL,fdopt);<br>        <span class="hljs-keyword">return</span> sockfd;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno != EINPROGRESS)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;unblock connect not support\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-comment">//select使用</span><br>    fd_set readfds;<br>    fd_set writefds;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">timeout</span>;</span><br><br>    FD_ZERO(&amp;readfds);<br>    FD_SET(sockfd,&amp;writefds);<br>    <br>    timeout.tv_sec = time;<br>    timeout.tv_usec = <span class="hljs-number">0</span>;<br><br>    ret = select(sockfd + <span class="hljs-number">1</span>,&amp;readfds,&amp;writefds,<span class="hljs-literal">NULL</span>,&amp;timeout);<br>    <span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">//超时未发生,或者有错误</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connection time out\n&quot;</span>);<br>        close(sockfd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//或者sockfd不在返回的writefds表中</span><br>    <span class="hljs-keyword">if</span> (!FD_ISSET(sockfd,&amp;writefds))<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;no events on sockfd found\n&quot;</span>);<br>        close(sockfd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//E IN PROGRESS 情况,</span><br>    <span class="hljs-keyword">int</span> error = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">socklen_t</span> length = <span class="hljs-keyword">sizeof</span>(error);<br>    <span class="hljs-comment">//获得SOL_SOCKET的SO_ERROR选项</span><br>    <span class="hljs-keyword">if</span> (getsockopt(sockfd,SOL_SOCKET,SO_ERROR,&amp;error,&amp;length) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get socket option failed\n&quot;</span>);<br>        close(sockfd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//error!=0说明不连接不成功,(出现其他错误</span><br>    <span class="hljs-keyword">if</span> (error != <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connection failed after select with the error: %d\n&quot;</span>,error);<br>        close(sockfd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-comment">//连接成功</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connection ready after select with the socket: %d\n&quot;</span>,sockfd);<br>    fcntl(sockfd,F_SETFL,fdopt);<span class="hljs-comment">//恢复成 block fd</span><br>    <span class="hljs-keyword">return</span> sockfd;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt;= <span class="hljs-number">2</span>)<br>        error_handle(<span class="hljs-string">&quot;argc &lt;= 2&quot;</span>)<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* ip = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br>    <br>    <span class="hljs-keyword">int</span> sockfd = unblock_connect(ip,port,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">if</span> (sockfd &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    close(sockfd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在*inx下不具有移植性</p>
</li>
<li><p>epoll实现监听同一端口的tcp和udp服务</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;me.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_EVENT_NUMBER 1024</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TCP_BUFFER_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UDP_BUFFER_SIZE 1024</span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setnonblocking</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> old_option = fcntl(fd,F_GETFL);<br>    <span class="hljs-keyword">int</span> new_option = old_option | O_NONBLOCK;<br>    fcntl(fd,F_SETFL,new_option);<br>    <span class="hljs-keyword">return</span> old_option;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> epollfd,<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">event</span>;</span><br>    event.data.fd = fd;<br>    event.events = EPOLLIN | EPOLLET;<span class="hljs-comment">//边沿触发模式</span><br>    epoll_ctl(epollfd,EPOLL_CTL_ADD,fd,&amp;event);<br>    setnonblocking(fd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt;= <span class="hljs-number">2</span>)<br>        error_handle(<span class="hljs-string">&quot;argc &lt;= 2&quot;</span>)<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ip = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;addr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(addr));<br>    addr.sin_family = AF_INET;<br>    addr.sin_port = htons(port);<br>    inet_pton(AF_INET,ip,&amp;addr.sin_addr);<br><br>    <span class="hljs-comment">//创建TCP SOCKET并且bind and listen</span><br>    <span class="hljs-keyword">int</span> listenfd = socket(AF_INET,SOCK_STREAM,<span class="hljs-number">0</span>);<br>    assert(listenfd &gt;= <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">int</span> ret = bind(listenfd,(struct sockaddr*)&amp;addr,<span class="hljs-keyword">sizeof</span>(addr));<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    ret = listen(listenfd,<span class="hljs-number">5</span>);<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">//创建UDP SOCKET</span><br>    <span class="hljs-built_in">memset</span>(&amp;addr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(addr));<br>    addr.sin_family = AF_INET;<br>    addr.sin_port = htons(port);<br>    inet_pton(AF_INET,ip,&amp;addr.sin_addr);<br><br>    <span class="hljs-keyword">int</span> udpfd = socket(AF_INET,SOCK_DGRAM,<span class="hljs-number">0</span>);<br>    assert(udpfd &gt;= <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">//监听相同端口</span><br>    ret = bind(udpfd,(struct sockaddr*)&amp;addr,<span class="hljs-keyword">sizeof</span>(addr));<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">events</span>[<span class="hljs-title">MAX_EVENT_NUMBER</span>];</span><br>    <span class="hljs-keyword">int</span> epollfd = epoll_create(<span class="hljs-number">5</span>);<br>    assert(epollfd != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-comment">//注册TCP UDP 监听socket上的可读事件</span><br>    addfd(epollfd,listenfd);<br>    addfd(epollfd,udpfd);<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">int</span> number = epoll_wait(epollfd,events,MAX_EVENT_NUMBER,<span class="hljs-number">-1</span>);<span class="hljs-comment">//一直阻塞到有事件发生</span><br>        <span class="hljs-keyword">if</span> (number &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;epoll failure\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;number; i++)<br>        &#123;<br>            <span class="hljs-keyword">int</span> sockfd = events[i].data.fd;<br>            <span class="hljs-keyword">if</span> (sockfd == listenfd)<br>            &#123;<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>                <span class="hljs-keyword">socklen_t</span> client_addrlength = <span class="hljs-keyword">sizeof</span>(client);<br>                <span class="hljs-keyword">int</span> connfd = accept(sockfd,(struct sockaddr*)&amp;client,&amp;client_addrlength);<br>                addfd(epollfd,connfd);<br>            &#125;<br>            <span class="hljs-comment">//udp socket有EPOLLIN事件应该是可读</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sockfd == udpfd)<br>            &#123;<br>                <span class="hljs-keyword">char</span> buf[UDP_BUFFER_SIZE];<br>                <span class="hljs-built_in">memset</span>(buf,<span class="hljs-string">&#x27;\0&#x27;</span>,UDP_BUFFER_SIZE);<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>                <span class="hljs-keyword">socklen_t</span> client_addrlength = <span class="hljs-keyword">sizeof</span>(client);<br>                ret = recvfrom(sockfd,buf,UDP_BUFFER_SIZE<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,(struct sockaddr*)&amp;client,&amp;client_addrlength);<br>                <span class="hljs-keyword">if</span> (ret &gt; <span class="hljs-number">0</span>)<span class="hljs-comment">//echo服务</span><br>                    sendto(sockfd,buf,UDP_BUFFER_SIZE<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>,(struct sockaddr*)&amp;client,client_addrlength);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (events[i].events &amp; EPOLLIN)<br>            &#123;<br>                <span class="hljs-comment">//建立TCP连接的新加入的TCP SOCKET</span><br>                <span class="hljs-keyword">char</span> buf[TCP_BUFFER_SIZE];<br>                <span class="hljs-comment">//ET模式不重复触发,循环读取完毕</span><br>                <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>                &#123;<br>                    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-string">&#x27;\0&#x27;</span>,TCP_BUFFER_SIZE);<br>                    ret = recv(sockfd,buf,TCP_BUFFER_SIZE<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)<br>                            <span class="hljs-keyword">break</span>;<span class="hljs-comment">//下次再处理</span><br>                        close(sockfd);<span class="hljs-comment">//其他的error,</span><br>                        epoll_ctl(epollfd,EPOLL_CTL_DEL,sockfd,<span class="hljs-literal">NULL</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>                    &#123;<br>                        close(sockfd);<br>                        epoll_ctl(epollfd,EPOLL_CTL_DEL,sockfd,<span class="hljs-literal">NULL</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//正常接收,正常发送</span><br>                        send(sockfd,buf,ret,<span class="hljs-number">0</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;something else happened \n&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    close(listenfd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>poll实现的聊天室server,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;me.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> USER_LIMIT 50</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 64</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_LIMIT 65535</span><br><br><span class="hljs-comment">//保存client的数据</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>    <span class="hljs-keyword">char</span>* write_buf;<br>    <span class="hljs-keyword">char</span> buf[BUFFER_SIZE];<br>&#125;client_data;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setnonblocking</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> old_option = fcntl(fd,F_GETFL);<br>    <span class="hljs-keyword">int</span> new_option = old_option | O_NONBLOCK;<br>    fcntl(fd,F_SETFL,new_option);<br>    <span class="hljs-keyword">return</span> old_option;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt;= <span class="hljs-number">2</span>)<br>        error_handle(<span class="hljs-string">&quot;argc &lt;= 2&quot;</span>)<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* ip = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;addr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(addr));<br>    addr.sin_family = AF_INET;<br>    addr.sin_port = htons(port);<br>    inet_pton(AF_INET,ip,&amp;addr.sin_addr);<br><br>    <span class="hljs-keyword">int</span> listenfd = socket(AF_INET,SOCK_STREAM,<span class="hljs-number">0</span>);<br>    assert(listenfd &gt;= <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">int</span> ret = bind(listenfd,(struct sockaddr*)&amp;addr,<span class="hljs-keyword">sizeof</span>(addr));<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    ret = listen(listenfd,<span class="hljs-number">5</span>);<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    client_data* users = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(client_data) * FD_LIMIT);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">fds</span>[<span class="hljs-title">USER_LIMIT</span> + 1];</span><span class="hljs-comment">//最多监听USER_LIMIT个用户</span><br>    <span class="hljs-keyword">int</span> user_counter = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i &lt;= USER_LIMIT; i++)<br>    &#123;<br>        fds[i].fd = <span class="hljs-number">-1</span>;<br>        fds[i].events = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//把listenfd首先加入到poll事件中</span><br>    fds[<span class="hljs-number">0</span>].fd = listenfd;<br>    fds[<span class="hljs-number">0</span>].events = POLLIN | POLLERR;<br>    fds[<span class="hljs-number">0</span>].revents = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        ret = poll(fds,user_counter+<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;poll failure\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">//poll会返回所有注册的事件,要遍历一次所有的事件</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;user_counter+<span class="hljs-number">1</span>; i++)<br>        &#123;<br>            <span class="hljs-comment">//处理新连接</span><br>            <span class="hljs-keyword">if</span> ((fds[i].fd == listenfd) &amp;&amp; (fds[i].revents &amp; POLLIN))<br>            &#123;<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>                <span class="hljs-keyword">socklen_t</span> client_addrlength = <span class="hljs-keyword">sizeof</span>(client);<br>                <span class="hljs-keyword">int</span> connfd = accept(listenfd,(struct sockaddr*)&amp;client,&amp;client_addrlength);<br>                <span class="hljs-keyword">if</span> (connfd &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;errno is: %d\n&quot;</span>,errno);<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                <span class="hljs-comment">/*请求超过连接限制*/</span><br>                <span class="hljs-keyword">if</span> (user_counter &gt;= USER_LIMIT)<br>                &#123;<br>                    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* info = <span class="hljs-string">&quot;too many users\n&quot;</span>;<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>,info);<br>                    send(connfd,info,<span class="hljs-built_in">strlen</span>(info),<span class="hljs-number">0</span>);<br>                    close(connfd);<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <br>                <span class="hljs-comment">//保存新连接connfd的信息 </span><br>                user_counter++;<br>                users[connfd].addr = client;<br>                setnonblocking(connfd);<span class="hljs-comment">//设置连接sock是non block的</span><br>                fds[user_counter].fd = connfd;<br>                fds[user_counter].events = POLLIN | POLLRDHUP | POLLERR;<br>                fds[user_counter].revents = <span class="hljs-number">0</span>;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;comes a new user,now have %d users\n&quot;</span>,user_counter);<br>            &#125;<br>            <span class="hljs-comment">//fd发生error事件</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fds[i].revents &amp; POLLERR)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get an error from %d\n&quot;</span>,fds[i].fd);<br>                <span class="hljs-keyword">char</span> errors[<span class="hljs-number">100</span>];<br>                <span class="hljs-built_in">memset</span>(errors,<span class="hljs-string">&#x27;\0&#x27;</span>,<span class="hljs-keyword">sizeof</span>(errors));<br>                <span class="hljs-keyword">socklen_t</span> length = <span class="hljs-keyword">sizeof</span>(errors);<br>                <span class="hljs-keyword">if</span> (getsockopt(fds[i].fd,SOL_SOCKET,SO_ERROR,errors,&amp;length) &lt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get socket option failed\n&quot;</span>);<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">//客户端关闭连接</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fds[i].revents &amp; POLLRDHUP)<br>            &#123;<br>                <span class="hljs-comment">//客户端资源 / 监听事件 2者移动到i处</span><br>                users[fds[i].fd] = users[fds[user_counter].fd];<br>                fds[i] = fds[user_counter--]; <br>                close(fds[i--].fd);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a client left\n&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">//客户端发来信息</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fds[i].revents &amp; POLLIN)<br>            &#123;<br>                <span class="hljs-keyword">int</span> connfd = fds[i].fd;<br>                <span class="hljs-built_in">memset</span>(users[connfd].buf,<span class="hljs-string">&#x27;\0&#x27;</span>,BUFFER_SIZE);<br>                ret = recv(connfd,users[connfd].buf,BUFFER_SIZE<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;get %d bytes of client data %s from %d \n&quot;</span>,ret,users[connfd].buf,connfd);<br>                <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (errno != EAGAIN)<span class="hljs-comment">//如果是其他错误,则关闭此连接,释放监听事件</span><br>                    &#123;<br>                        close(connfd);<br>                        users[fds[i].fd] = users[fds[user_counter].fd];<br>                        fds[i--] = fds[user_counter--];<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>                &#123;&#125;<br>                <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//接收到客户端发来的数据,</span><br>                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>; j&lt;=user_counter; j++)<br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (fds[j].fd == connfd)<span class="hljs-comment">//不需要将信息发送给自己</span><br>                            <span class="hljs-keyword">continue</span>;<br>                        <span class="hljs-comment">// fds[j].events |= ~POLLIN;</span><br>                        fds[j].events &amp;= ~POLLIN;<span class="hljs-comment">//取消原POLLIN事件</span><br>                        fds[j].events |= POLLOUT;<span class="hljs-comment">//在有接受数据的fd上注册POLLOUT事件</span><br>                        users[fds[j].fd].write_buf = users[connfd].buf;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//发送待发送的数据</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fds[i].revents &amp; POLLOUT)<br>            &#123;<br>                <span class="hljs-keyword">int</span> connfd = fds[i].fd;<br>                <span class="hljs-keyword">if</span> (!users[connfd].write_buf)<br>                    <span class="hljs-keyword">continue</span>;<br>                ret = send(connfd,users[connfd].write_buf,<span class="hljs-built_in">strlen</span>(users[connfd].write_buf),<span class="hljs-number">0</span>);<br>                users[connfd].write_buf = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//清除带发送数据</span><br>                <span class="hljs-comment">// fds[i].events |= ~POLLOUT;</span><br>                fds[i].events &amp;= ~POLLOUT;<span class="hljs-comment">//取消原POLLOUT事件</span><br>                fds[i].events |= POLLIN;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(users);<br>    close(listenfd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以用下面的client来测试聊天室的效果:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;me.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUF_SIZE 100</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NAME_SIZE 20</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">send_msg</span><span class="hljs-params">(<span class="hljs-keyword">void</span>*)</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">recv_msg</span><span class="hljs-params">(<span class="hljs-keyword">void</span>*)</span></span>;<br><br><span class="hljs-keyword">char</span> name[NAME_SIZE] = <span class="hljs-string">&quot;[DEFAULT]&quot;</span>;<br><span class="hljs-keyword">char</span> msg[BUF_SIZE];<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sock;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">serv_adr</span>;</span><br>  <span class="hljs-keyword">pthread_t</span> snd_thread,rcv_thread;<br>  <span class="hljs-keyword">void</span> *thread_return;<br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">4</span>)<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Usage : %s &lt;IP&gt; &lt;port&gt; &lt;name&gt;\n&quot;</span>,argv[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">sprintf</span>(name,<span class="hljs-string">&quot;[%s]&quot;</span>,argv[<span class="hljs-number">3</span>]);<span class="hljs-comment">//将名字加入到待发送的buf中 </span><br>  sock = socket(AF_INET,SOCK_STREAM,<span class="hljs-number">0</span>);<br><br>  <span class="hljs-built_in">memset</span>(&amp;serv_adr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(serv_adr));<br>  serv_adr.sin_family = AF_INET;<br>  serv_adr.sin_addr.s_addr = inet_addr(argv[<span class="hljs-number">1</span>]);<br>  serv_adr.sin_port = htons(atoi(argv[<span class="hljs-number">2</span>]));<br><br>  <span class="hljs-keyword">if</span> (connect(sock,(struct sockaddr*)&amp;serv_adr,<span class="hljs-keyword">sizeof</span>(serv_adr)) == <span class="hljs-number">-1</span>)<br>    error_handle(<span class="hljs-string">&quot;connect() error&quot;</span>)<br><br>  <span class="hljs-comment">//创建发送和接受消息的线程 </span><br>  pthread_create(&amp;snd_thread,<span class="hljs-literal">NULL</span>,send_msg,(<span class="hljs-keyword">void</span>*)&amp;sock);<br>  pthread_create(&amp;rcv_thread,<span class="hljs-literal">NULL</span>,recv_msg,(<span class="hljs-keyword">void</span>*)&amp;sock);<br><br>  pthread_join(snd_thread,&amp;thread_return);<br>  pthread_join(rcv_thread,&amp;thread_return);<br>  close(sock);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">send_msg</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sock = *((<span class="hljs-keyword">int</span> *)arg);<br>  <span class="hljs-keyword">char</span> name_msg[NAME_SIZE + BUF_SIZE];<br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>  &#123;<br>    fgets(msg,BUF_SIZE,<span class="hljs-built_in">stdin</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(msg,<span class="hljs-string">&quot;q\n&quot;</span>) || !<span class="hljs-built_in">strcmp</span>(msg,<span class="hljs-string">&quot;Q\n&quot;</span>))<br>    &#123;<br>      close(sock);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">sprintf</span>(name_msg,<span class="hljs-string">&quot;%s %s&quot;</span>,name,msg);<br>    write(sock,name_msg,<span class="hljs-built_in">strlen</span>(name_msg));<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">recv_msg</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> sock = *((<span class="hljs-keyword">int</span>*)arg);<br>  <span class="hljs-keyword">char</span> name_msg[NAME_SIZE + BUF_SIZE];<br>  <span class="hljs-keyword">int</span> str_len;<br>  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<span class="hljs-comment">//服务器发送消息到所有客户端 </span><br>  &#123;<br>    str_len = read(sock,name_msg,NAME_SIZE+BUF_SIZE<span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">if</span> (str_len == <span class="hljs-number">-1</span>)<br>      <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span>*)<span class="hljs-number">-1</span>;<br>    name_msg[str_len] = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fputs</span>(name_msg,<span class="hljs-built_in">stdout</span>); <span class="hljs-comment">//接受消息,打印到客户端 </span><br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



</li>
</ol>
<hr>
<h4 id="将信号通过全双工pipe转化为IO事件-然后-由IO多路统一处理信号和IO事件"><a href="#将信号通过全双工pipe转化为IO事件-然后-由IO多路统一处理信号和IO事件" class="headerlink" title="将信号通过全双工pipe转化为IO事件 然后 由IO多路统一处理信号和IO事件"></a>将信号通过全双工pipe转化为IO事件 然后 由IO多路统一处理信号和IO事件</h4><blockquote>
<p>利用signal的SA_RESTART flags,系统调用被信号处理函数中断后能够重新被调用</p>
<p>这里仅修改了4个信号的默认处理函数,</p>
<p>通过kill -signo pid测试是否成功转换为IO事件</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;me.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_EVENT_NUMBER 1024</span><br><br><span class="hljs-keyword">int</span> pipefd[<span class="hljs-number">2</span>];<br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">setnonblocking</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> old_option = fcntl(fd,F_GETFL);<br>    <span class="hljs-keyword">int</span> new_option = old_option | O_NONBLOCK;<br>    fcntl(fd,F_SETFL,new_option);<br>    <span class="hljs-keyword">return</span> old_option;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addfd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> epollfd,<span class="hljs-keyword">int</span> fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">event</span>;</span><br>    event.data.fd = fd;<br>    event.events = EPOLLIN | EPOLLET;<span class="hljs-comment">//边沿触发模式</span><br>    epoll_ctl(epollfd,EPOLL_CTL_ADD,fd,&amp;event);<br>    setnonblocking(fd);<span class="hljs-comment">//边沿模式下,fd需要nonblock,避免触发后一直被block</span><br>&#125;<br><br><span class="hljs-comment">//信号处理函数</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sig_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> signo)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> save_errno = errno;<br>    <span class="hljs-keyword">int</span> msg = signo;<br>    send(pipefd[<span class="hljs-number">1</span>],(<span class="hljs-keyword">char</span>*)&amp;msg,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<span class="hljs-comment">//1Byte大小足够表示所有信号了</span><br>    errno = save_errno;<br>&#125;<br><br><span class="hljs-comment">//注册信号signo的处理函数</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addsig</span><span class="hljs-params">(<span class="hljs-keyword">int</span> signo)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;sa,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(sa));<br>    sa.sa_handler = sig_handler;<br>    sa.sa_flags |= SA_RESTART;<span class="hljs-comment">//重启被中断的系统调用</span><br>    sigfillset(&amp;sa.sa_mask);<br>    assert(sigaction(signo,&amp;sa,<span class="hljs-literal">NULL</span>) != <span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc,<span class="hljs-keyword">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt;= <span class="hljs-number">2</span>)<br>        error_handle(<span class="hljs-string">&quot;argc &lt;= 2&quot;</span>)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pid = %d\n&quot;</span>,getpid());<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ip = argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">int</span> port = atoi(argv[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;addr,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(addr));<br>    addr.sin_family = AF_INET;<br>    addr.sin_port = htons(port);<br>    inet_pton(AF_INET,ip,&amp;addr.sin_addr);<br><br>    <span class="hljs-keyword">int</span> listenfd = socket(AF_INET,SOCK_STREAM,<span class="hljs-number">0</span>);<br>    assert(listenfd &gt;= <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">int</span> ret = bind(listenfd,(struct sockaddr*)&amp;addr,<span class="hljs-keyword">sizeof</span>(addr)); <br>    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;errno is %d\n&quot;</span>,errno);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    ret = listen(listenfd,<span class="hljs-number">5</span>);<br>    assert(ret != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">events</span>[<span class="hljs-title">MAX_EVENT_NUMBER</span>];</span><br>    <span class="hljs-keyword">int</span> epollfd = epoll_create(<span class="hljs-number">5</span>);<br>    assert(epollfd != <span class="hljs-number">-1</span>);<br>    addfd(epollfd,listenfd);<br><br>    <span class="hljs-comment">//全双工,本地,unnamed socket</span><br>    ret = socketpair(AF_UNIX,SOCK_STREAM,<span class="hljs-number">0</span>,pipefd);<br>    assert(ret != <span class="hljs-number">-1</span>);<br>    setnonblocking(pipefd[<span class="hljs-number">1</span>]);<br>    addfd(epollfd,pipefd[<span class="hljs-number">0</span>]);<br><br>    addsig(SIGHUP);<br>    addsig(SIGCHLD);<br>    addsig(SIGTERM);<br>    addsig(SIGINT);<br>    <span class="hljs-keyword">bool</span> stop_server = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">while</span>(!stop_server)<br>    &#123;<br>        <span class="hljs-keyword">int</span> number = epoll_wait(epollfd,events,MAX_EVENT_NUMBER,<span class="hljs-number">-1</span>);<br>        <span class="hljs-comment">//函数执行错误的原因不是被信号处理程序中断了</span><br>        <span class="hljs-keyword">if</span> ((number &lt; <span class="hljs-number">0</span>) &amp;&amp; (errno != EINTR))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;epoll failure\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;number; i++)<br>        &#123;<br>            <span class="hljs-keyword">int</span> sockfd = events[i].data.fd;<br>            <span class="hljs-keyword">if</span> (sockfd == listenfd)<br>            &#123;<br>                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client</span>;</span><br>                <span class="hljs-keyword">socklen_t</span> client_addrlength = <span class="hljs-keyword">sizeof</span>(client);<br>                <span class="hljs-keyword">int</span> connfd = accept(sockfd,(struct sockaddr*)&amp;client,&amp;client_addrlength);<br>                addfd(epollfd,connfd);<br>            &#125;<br>            <span class="hljs-comment">//本地socket有EPOLLIN事件发生</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((sockfd == pipefd[<span class="hljs-number">0</span>]) &amp;&amp; (events[i].events &amp; EPOLLIN)) <br>            &#123;<br>                <span class="hljs-keyword">int</span> signo;<br>                <span class="hljs-keyword">char</span> signals[<span class="hljs-number">1024</span>];<span class="hljs-comment">//给每个signal排队</span><br>                ret = recv(pipefd[<span class="hljs-number">0</span>],signals,<span class="hljs-keyword">sizeof</span>(signals),<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">else</span> <br>                &#123;<br>                    <span class="hljs-comment">//接收到由ret个信号处理程序发过来的signo</span><br>                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ret; i++)<br>                    &#123;<br>                        <span class="hljs-keyword">switch</span>(signals[i])<br>                        &#123;<br>                        <span class="hljs-keyword">case</span> SIGCHLD:<br>                        <span class="hljs-keyword">case</span> SIGHUP:<br>                            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;receive SIGCHLD / SIGHUP\n&quot;</span>);<br>                            <span class="hljs-keyword">continue</span>;<br>                        <span class="hljs-keyword">case</span> SIGTERM:<br>                        <span class="hljs-keyword">case</span> SIGINT:<br>                            stop_server = <span class="hljs-literal">true</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;&#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;close fds\n&quot;</span>);<br>    close(listenfd);<br>    close(pipefd[<span class="hljs-number">0</span>]);<br>    close(pipefd[<span class="hljs-number">1</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/socket/">socket</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/18/csdn/%E4%BD%BF%E7%94%A8UNIX%E5%9F%9FSocket%E4%BC%A0%E9%80%92%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">使用UNIX域Socket传递文件描述符</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/10/30/csdn/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9E%E4%BE%8B!%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84HTTP%E8%AF%B7%E6%B1%82%E7%9A%84%E8%AF%BB%E5%8F%96%E5%92%8C%E5%88%86%E6%9E%90/">
                        <span class="hidden-mobile">有限状态机实例:服务端实现简单的HTTP请求的读取和分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
